<!-- Include Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Include D3.js library -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Include Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<div id="mapid" style="width: 600px; height: 400px;"></div>

<script>
var mymap = L.map('mapid').setView([51.505, -0.09], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
}).addTo(mymap);

// Fetch data from the /data endpoint
fetch('/data')
    .then(response => response.json())
    .then(locations => {
        // Define a color scale using d3
        var colorScale = d3.scaleLinear()
            .domain([minCapRate, maxCapRate])  // Define the domain of cap rates
            .range(["green", "red"]);  // Define the range of colors from green to red

        // Function to get color based on cap rate
        function getColor(capRate) {
            return colorScale(capRate);
        }

        // Add circles to the map based on the fetched locations
        locations.forEach(loc => {
            var popupContent = `<b>City Name:</b> ${loc.RegionName}<br>` +
                               `<b>Rental Rates:</b> ${loc.Recent_Month_tx_rental}<br>` +
                               `<b>Home Values:</b> ${loc.Recent_Month_home_values}<br>` +
                               `<b>Cap Rate:</b> ${loc.cap_rate}`;

            L.circleMarker([loc.lat, loc.lng], { color: getColor(loc.cap_rate) }).addTo(mymap)
                .bindPopup(popupContent);
        });
    })
    .catch(error => console.error('Error fetching data:', error));
</script>